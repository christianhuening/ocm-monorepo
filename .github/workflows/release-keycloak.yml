name: Release Keycloak Component

on:
  push:
    tags:
      - 'keycloak-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Keycloak version to release (e.g., 26.4.5)'
        required: true
        type: string

env:
  COMPONENT_NAME: keycloak
  OCM_VERSION: 0.18.0

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#keycloak-v}"  # Remove keycloak-v prefix
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building Keycloak component version: $VERSION"

      - name: Install OCM CLI
        run: |
          curl -sL https://github.com/open-component-model/ocm/releases/download/v${OCM_VERSION}/ocm-${OCM_VERSION}-linux-amd64.tar.gz | tar xz
          sudo mv ocm /usr/local/bin/
          ocm version

      - name: Verify component structure
        run: |
          cd ${{ env.COMPONENT_NAME }}

          # Check all required files exist
          test -f component-constructor.yaml || (echo "Missing component-constructor.yaml" && exit 1)
          test -f operator/keycloaks-crd.yml || (echo "Missing operator CRDs" && exit 1)
          test -f operator/operator.yml || (echo "Missing operator deployment" && exit 1)
          test -f configs/minimal/keycloak.yml || (echo "Missing minimal config" && exit 1)
          test -f configs/production/keycloak.yml || (echo "Missing production config" && exit 1)

          echo "✓ All required files present"

      - name: Update component version
        run: |
          cd ${{ env.COMPONENT_NAME }}
          sed -i "s/version:.*/version: ${{ steps.version.outputs.version }}/" component-constructor.yaml
          echo "Updated component version to ${{ steps.version.outputs.version }}"

      - name: Build OCM component
        run: |
          cd ${{ env.COMPONENT_NAME }}

          # Create Common Transport Archive
          ocm add componentversions --create --file ../keycloak-component.ctf component-constructor.yaml

          echo "✓ OCM component built successfully"
          ls -lh ../keycloak-component.ctf

      - name: Create offline package (tar.gz)
        run: |
          # Create offline package directory
          mkdir -p offline-package/${{ env.COMPONENT_NAME }}

          # Copy component archive
          cp keycloak-component.ctf offline-package/${{ env.COMPONENT_NAME }}/

          # Copy installation scripts and documentation
          cp -r ${{ env.COMPONENT_NAME }}/operator offline-package/${{ env.COMPONENT_NAME }}/
          cp -r ${{ env.COMPONENT_NAME }}/configs offline-package/${{ env.COMPONENT_NAME }}/
          cp ${{ env.COMPONENT_NAME }}/README.md offline-package/${{ env.COMPONENT_NAME }}/

          # Create installation script
          cat > offline-package/${{ env.COMPONENT_NAME }}/install.sh <<'INSTALL_EOF'
          #!/usr/bin/env bash
          set -euo pipefail

          echo "Installing Keycloak component..."

          # Install operator
          echo "Installing Keycloak operator..."
          kubectl apply -f operator/keycloaks-crd.yml
          kubectl apply -f operator/keycloakrealmimports-crd.yml
          kubectl apply -f operator/operator.yml

          echo "Waiting for operator to be ready..."
          kubectl wait --for=condition=Available deployment/keycloak-operator --timeout=120s

          echo "✓ Keycloak operator installed successfully"
          echo ""
          echo "To deploy Keycloak, choose a configuration:"
          echo "  Minimal (dev/test):  kubectl apply -f configs/minimal/keycloak.yml"
          echo "  Production (HA):     kubectl apply -f configs/production/keycloak.yml"
          INSTALL_EOF

          chmod +x offline-package/${{ env.COMPONENT_NAME }}/install.sh

          # Create package tarball
          tar -czf keycloak-${{ steps.version.outputs.version }}-offline.tar.gz -C offline-package ${{ env.COMPONENT_NAME }}

          echo "✓ Offline package created"
          ls -lh keycloak-${{ steps.version.outputs.version }}-offline.tar.gz

      - name: Generate checksums
        run: |
          sha256sum keycloak-${{ steps.version.outputs.version }}-offline.tar.gz > keycloak-${{ steps.version.outputs.version }}-offline.tar.gz.sha256
          cat keycloak-${{ steps.version.outputs.version }}-offline.tar.gz.sha256

      - name: Create release notes
        run: |
          cat > release-notes.md <<EOF
          # Keycloak OCM Component v${{ steps.version.outputs.version }}

          This release packages Keycloak v${{ steps.version.outputs.version }} as an OCM (Open Component Model) component for air-gapped and offline deployments.

          ## What's Included

          - **Keycloak Operator** v${{ steps.version.outputs.version }}
            - Custom Resource Definitions (CRDs)
            - Operator deployment manifests
            - RBAC configuration

          - **Keycloak Container Images**
            - \`quay.io/keycloak/keycloak-operator:${{ steps.version.outputs.version }}\`
            - \`quay.io/keycloak/keycloak:${{ steps.version.outputs.version }}\`

          - **Configurations**
            - Minimal configuration (dev/test with ephemeral database)
            - Production HA configuration (3 replicas, external database)

          - **Documentation**
            - Installation guide
            - Configuration examples
            - Troubleshooting tips

          ## Installation

          ### For Air-Gapped Environments

          1. Download the offline package:
             \`\`\`bash
             wget https://github.com/${{ github.repository }}/releases/download/keycloak-v${{ steps.version.outputs.version }}/keycloak-${{ steps.version.outputs.version }}-offline.tar.gz
             \`\`\`

          2. Verify checksum:
             \`\`\`bash
             sha256sum -c keycloak-${{ steps.version.outputs.version }}-offline.tar.gz.sha256
             \`\`\`

          3. Extract and install:
             \`\`\`bash
             tar -xzf keycloak-${{ steps.version.outputs.version }}-offline.tar.gz
             cd keycloak
             ./install.sh
             \`\`\`

          ### Using OCM CLI

          \`\`\`bash
          # Install OCM CLI from https://ocm.software/docs/cli-reference/install/

          # Transfer component to your registry
          ocm transfer ctf keycloak-component.ctf oci://your-registry/ocm-components

          # In air-gapped environment
          ocm transfer oci://your-registry/ocm-components ctf keycloak-airgapped.ctf
          \`\`\`

          ## Requirements

          - Kubernetes 1.24+
          - PostgreSQL database (included in minimal config, external required for production)
          - 2GB RAM minimum (development), 8GB+ recommended (production)

          ## Dependencies

          ### Recommended for Production
          - CloudNativePG or external PostgreSQL database
          - cert-manager for TLS certificates
          - NGINX Ingress Controller
          - External Secrets Operator (for secret management)
          - Prometheus Operator (for monitoring)

          See [suggested-components.md](https://github.com/${{ github.repository }}/blob/main/suggested-components.md) for details.

          ## Quick Start

          \`\`\`bash
          # Install operator
          kubectl apply -f operator/keycloaks-crd.yml
          kubectl apply -f operator/keycloakrealmimports-crd.yml
          kubectl apply -f operator/operator.yml

          # Deploy minimal config
          kubectl apply -f configs/minimal/keycloak.yml

          # Get admin credentials
          kubectl get secret keycloak-initial-admin -n keycloak -o jsonpath='{.data.username}' | base64 -d
          kubectl get secret keycloak-initial-admin -n keycloak -o jsonpath='{.data.password}' | base64 -d
          \`\`\`

          ## Documentation

          - [Component README](https://github.com/${{ github.repository }}/blob/main/keycloak/README.md)
          - [Official Keycloak Documentation](https://www.keycloak.org/documentation)
          - [OCM Documentation](https://ocm.software/docs/)

          ## Checksums

          \`\`\`
          $(cat keycloak-${{ steps.version.outputs.version }}-offline.tar.gz.sha256)
          \`\`\`

          ## Support

          - Report issues: https://github.com/${{ github.repository }}/issues
          - Keycloak issues: https://github.com/keycloak/keycloak/issues
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: keycloak-v${{ steps.version.outputs.version }}
          name: Keycloak v${{ steps.version.outputs.version }}
          body_path: release-notes.md
          files: |
            keycloak-${{ steps.version.outputs.version }}-offline.tar.gz
            keycloak-${{ steps.version.outputs.version }}-offline.tar.gz.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Keycloak component v${{ steps.version.outputs.version }} released successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Offline package: \`keycloak-${{ steps.version.outputs.version }}-offline.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- Checksum: \`keycloak-${{ steps.version.outputs.version }}-offline.tar.gz.sha256\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release URL" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/tag/keycloak-v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
